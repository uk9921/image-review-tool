<!DOCTYPE html>
<html lang="zh-CN" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>ä¿å­˜çš„å¤šåª’ä½“å±•ç¤ºä¸é€‰æ‹©å·¥å…·</title>
    <style>
        /* --- åŸºç¡€å˜é‡ --- */
        :root {
            /* æµ…è‰²ä¸»é¢˜å˜é‡ */
            --background-color: #f8f9fa;
            --toolbar-background: #ffffff;
            --text-color: #333;
            --button-background: #007BFF;
            --button-hover: #0069d9;
            --button-disabled: #e9ecef;
            --button-text-disabled: #adb5bd;
            --media-background: #fff;
            --checkbox-background: rgba(255, 255, 255, 0.9);
            --feedback-color: #28a745;
            --modal-background: #fff;
            --modal-text-color: #333;
            --search-modal-background: #fff;
            --search-modal-text-color: #333;
            --input-border: #ced4da;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* æ·±è‰²ä¸»é¢˜å˜é‡ */
        .dark-theme {
            --background-color: #1e1e1e;
            --toolbar-background: #2d2d2d;
            --text-color: #e0e0e0;
            --button-background: #3a86ff;
            --button-hover: #2667cc;
            --button-disabled: #444;
            --button-text-disabled: #777;
            --media-background: #333;
            --checkbox-background: rgba(50, 50, 50, 0.9);
            --feedback-color: #4caf50;
            --modal-background: #424242;
            --modal-text-color: #f4f4f4;
            --search-modal-background: #424242;
            --search-modal-text-color: #f4f4f4;
            --input-border: #555;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.5);
        }
        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        /* --- é¡¶éƒ¨å·¥å…·æ  --- */
        .toolbar {
            background-color: var(--toolbar-background);
            padding: 15px 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s, box-shadow 0.3s;
            border-bottom: 1px solid var(--input-border);
        }
        .toolbar .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: center;
        }
        .toolbar label {
            margin-right: 4px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-color);
        }
        .toolbar input[type="text"],
        .toolbar input[type="number"],
        .toolbar textarea {
            padding: 8px 10px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            width: 100px;
            max-width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            transition: all 0.3s;
            outline: none;
            background-color: var(--media-background);
            color: var(--text-color);
        }
        .toolbar input:focus, .toolbar textarea:focus {
            border-color: var(--button-background);
            box-shadow: 0 0 0 2px rgba(0,123,255, 0.15);
        }
        .toolbar textarea {
            resize: vertical;
            height: 38px;
            min-height: 38px;
            vertical-align: middle;
        }
        .toolbar button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background-color: var(--button-background);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            height: 38px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        .toolbar button:hover {
            background-color: var(--button-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .toolbar button:active {
            transform: translateY(0);
        }
        .toolbar button:disabled {
            background-color: var(--button-disabled);
            color: var(--button-text-disabled);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .autoplay-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--button-background);
            color: white;
            padding: 0 16px;
            height: 38px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            border: none;
            user-select: none;
            box-shadow: var(--shadow-sm);
        }
        .autoplay-toggle:hover {
            background-color: var(--button-hover);
            transform: translateY(-1px);
        }
        .autoplay-toggle.disabled {
            background-color: #6c757d;
        }
        .toolbar button.icon-btn {
            background-color: transparent;
            color: var(--text-color);
            box-shadow: none;
            font-size: 20px;
            padding: 0 8px;
            margin-left: 4px;
        }
        .toolbar button.icon-btn:hover {
            color: var(--button-background);
            background-color: rgba(0,0,0,0.05);
            transform: none;
        }
        .save-button {
            background-color: #28a745 !important;
        }
        .save-button:hover {
            background-color: #218838 !important;
        }
        
        /* --- åª’ä½“ç½‘æ ¼ --- */
        #container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            justify-items: stretch;
            justify-items: center;
            justify-content: center;
        }
        .media-item {
            position: relative;
            background-color: var(--media-background);
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, width 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 500px;
            min-height: 100px;
            z-index: 1;
        }
        .media-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .media-content {
            width: 100%;
            height: auto;
            display: block;
            flex-grow: 1;
            object-fit: contain;
        }
        
        /* --- åˆ†è¾¨ç‡æ ‡ç­¾ (New Requirement #1) --- */
        .resolution-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.65);
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none; /* è®©é¼ æ ‡ç‚¹å‡»ç©¿é€ */
            z-index: 10;
            font-family: Consolas, monospace;
            backdrop-filter: blur(2px);
        }
        .media-item:hover .resolution-badge {
            opacity: 1;
        }

        /* æ–‡æœ¬å†…å®¹ */
        .text-content {
            padding: 10px;
            white-space: pre-wrap;
            word-break: break-word;
            flex-grow: 1;
            font-family: Consolas, "Courier New", monospace;
            border-radius: 4px;
            overflow-x: auto;
        }
        .json-key { color: #c92c2c; }
        .json-string { color: #22863a; }
        .json-number { color: #005cc5; }
        .json-boolean { color: #d73a49; }
        .json-null { color: #6a737d; }

        /* æ§ä»¶æ‚¬æµ®æ ·å¼ */
        .audio-button {
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 5px;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s, background-color 0.3s;
            pointer-events: auto;
            width: 30px;
            height: 30px;
            font-size: 16px;
        }
        .media-item:hover .audio-button { opacity: 1; }
        
        .checkbox-container {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--checkbox-background);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 2px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .media-item:hover .checkbox-container,
        .media-item.selected .checkbox-container {
            opacity: 1;
            pointer-events: auto;
        }
        .checkbox-container input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        /* åé¦ˆæ¶ˆæ¯ */
        #feedback {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            pointer-events: none;
        }
        #feedback.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #feedback.error {
            background-color: rgba(220, 53, 69, 0.9);
        }

        /* å…¶ä»–å¸ƒå±€ */
        #output {
            width: calc(100% - 40px);
            margin: 0 20px 20px 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            box-sizing: border-box;
            height: 100px;
        }
        @media (max-width: 800px) {
            .toolbar .controls { flex-direction: column; align-items: stretch; }
            .toolbar input, .toolbar textarea { width: 100%; }
            #output { width: calc(100% - 40px); }
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: var(--modal-background);
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 8px;
            color: var(--modal-text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .batch-buttons {
            margin: 20px 0 10px 0;
            text-align: center;
        }
        .batch-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background-color: var(--button-background);
            color: white;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.2s;
        }
        .batch-buttons button:hover {
             background-color: var(--button-hover);
        }
        #searchModal .modal-content {
            background-color: var(--search-modal-background);
            color: var(--search-modal-text-color);
        }
        .search-mode { margin-top: 10px; }
        .search-mode label { margin-right: 10px; }

        /* æ”¾å¤§é•œç›¸å…³ */
        .zoom-box {
            position: fixed;
            width: 400px;
            height: 400px;
            border: 1px solid #333;
            overflow: hidden;
            display: none;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .magnifier-box {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 1px solid white;
            background-color: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            display: none;
            z-index: 1001;
        }

        /* æµ®åŠ¨å¼¹å‡ºæ¡† */
        .popup {
            position: absolute;
            width: 500px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 3000;
            padding: 20px;
            color: #fff;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .popup::after {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            z-index: -1;
        }
        .popup.arrow-left::after {
            border-width: 10px 10px 10px 0;
            border-color: transparent #fff transparent transparent;
            left: -10px;
            top: 20px;
        }
        .popup.arrow-right::after {
            border-width: 10px 0 10px 10px;
            border-color: transparent transparent transparent #fff;
            right: -10px;
            top: 20px;
        }
        .popup.show {
            opacity: 1;
            pointer-events: auto;
        }
        .popup .popup-media-container {
            max-height: 80vh;
            overflow: auto;
        }
        .popup-media-container img,
        .popup-media-container video {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }

        /* æ ‡é¢˜æ  */
        h1 { text-align: center; margin: 30px 0; }
        .haojia-font {
            font-family: "è±ªä½³ä½“", sans-serif;
            font-weight: 600;
            color: #2d2d2d;
        }
        .copyright {
            position: absolute;
            top: 45px;
            left: 50%;
            z-index: 1001;
            color: var(--text-color);
            padding: 8px 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 0.65em;
            margin: 0.5rem 12rem 0.8rem;
            opacity: 0.8;
        }
    </style>
</head>
<body class="light-theme">
    <div class="header">
        <h1>å¤šåª’ä½“å±•ç¤ºä¸é€‰æ‹©å·¥å…·</h1>
        <a href="https://uk9921.github.io/image-review-tool/"
           style="color: inherit; text-decoration: none;"
                   data-hotkey="g d"
                   aria-label="Homepage"
                   data-turbo="false">
            <div class="copyright">Â© ç‰ˆæƒå½’å±:æ·˜å¤©ä¸šåŠ¡æŠ€æœ¯-<span class="team" style="font-weight: bold;">AIåŸç”Ÿåº”ç”¨-å†…å®¹AI-è§†é¢‘ç”Ÿæˆ</span>

                  <span class="team"  style="font-weight: bold;">è±ªä½³</span>
                  <svg height="9" aria-hidden="true" viewBox="0 0 24 24" version="1.1" width="10" data-view-component="true" class="octicon octicon-mark-github v-align-middle">
                    <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"></path>
                  </svg>
            </div>
        </a>
    </div>
    <div class="toolbar">
        <div class="controls">
            <div>
                <label for="input">åª’ä½“é“¾æ¥ï¼š</label><br>
                <textarea id="input" placeholder="é“¾æ¥ç²˜è´´å¤„..." style="width: 200px;"></textarea>
            </div>
            <div>
                <button onclick="loadImages()">åŠ è½½åª’ä½“</button>
                <button onclick="prevPage()" id="prevButton" disabled>ä¸Šä¸€é¡µ</button>
                <button onclick="nextPage()" id="nextButton" disabled>ä¸‹ä¸€é¡µ</button>
                <button id="exportButton" onclick="exportImages()" disabled>å¯¼å‡ºé€‰ä¸­</button>
                <button class="save-button" onclick="savePage()">ä¿å­˜é¡µé¢</button>
            </div>
            <div>
                <label class="autoplay-toggle" id="autoplayToggle" onclick="toggleAutoplay()">
                    <input type="checkbox" id="autoplayCheckbox" checked>
                    <span id="autoplayLabel">ğŸ¬ è‡ªåŠ¨æ’­æ”¾</span>
                </label>
            </div>
            <div>
                <label for="pageSizeInput">æ¯é¡µè¡Œæ•°ï¼š</label><br>
                <input type="number" id="pageSizeInput" placeholder="ä¾‹å¦‚ï¼š2" min="1">
            </div>
            <div>
                <label for="lineSizeInput">æ¯è¡Œæ•°é‡ï¼š</label><br>
                <input type="number" id="lineSizeInput" placeholder="ä¾‹å¦‚ï¼š4" min="1">
            </div>
            <div>
                <label for="goToPageInput">è·³è½¬åˆ°é¡µç ï¼š</label><br>
                <input type="text" id="goToPageInput" placeholder="ä¾‹å¦‚ï¼š1">
            </div>
            <button class="command-icon icon-btn" onclick="openCommandHelp()" title="æ”¾å¤§">âŒ˜</button>
            <button class="search-icon icon-btn" onclick="openSearch()" title="æœç´¢åª’ä½“">ğŸ”</button>
            <button class="theme-toggle icon-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
            <button class="help-button icon-btn" onclick="openHelp()" title="å¸®åŠ©">â“</button>
        </div>
    </div>
    <div class="batch-buttons">
        <button onclick="selectAll()">å…¨é€‰æœ¬é¡µ</button>
        <button onclick="deselectAll()">å–æ¶ˆå…¨é€‰</button>
    </div>
    <p style="text-align:center;">å½“å‰ç¬¬<span id="current">0</span>é¡µï¼Œå…±<span id="total">0</span>é¡µ</p>
    <div id="container"></div>
    <p style="text-align:center;">å¯¼å‡ºçš„é“¾æ¥ï¼š</p>
    <textarea id="output" readonly></textarea>
    <div id="feedback"></div>

    <!-- æ¨¡æ€æ¡†ä»¬ -->
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeSearch()">&times;</span>
            <h2>æœç´¢åª’ä½“</h2>
            <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯æˆ–æ­£åˆ™è¡¨è¾¾å¼" style="width: 100%; padding: 8px; box-sizing: border-box;">
            <div class="search-mode">
                <label><input type="radio" name="searchMode" value="keyword" checked> å…³é”®è¯</label>
                <label><input type="radio" name="searchMode" value="regex"> æ­£åˆ™è¡¨è¾¾å¼</label>
            </div>
            <button onclick="performSearch()" style="margin-top: 10px;">æœç´¢</button>
            <button onclick="clearSearch()" style="margin-top: 10px; margin-left: 10px;">æ¸…ç©ºæœç´¢</button>
        </div>
    </div>
    <div id="commandModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCommandHelp()">&times;</span>
            <p>æŒ‰ä¸‹âŒ˜é”®å¼€å§‹æ”¾å¤§ã€‚</p>
        </div>
    </div>
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeHelp()">&times;</span>
            <h2>ä½¿ç”¨æŒ‡å—</h2>
            <p>æ¬¢è¿ä½¿ç”¨å¤šåª’ä½“å±•ç¤ºä¸é€‰æ‹©å·¥å…·ã€‚ä»¥ä¸‹æ˜¯å„åŠŸèƒ½çš„ä½¿ç”¨è¯´æ˜ï¼š</p>
            <ul>
                <li><strong>åŠ è½½åª’ä½“ï¼š</strong>ç²˜è´´é“¾æ¥æ¯è¡Œä¸€ä¸ªï¼Œç‚¹å‡»"åŠ è½½åª’ä½“"ã€‚</li>
                <li><strong>æ”¾å¤§æŸ¥çœ‹ï¼š</strong>æŒ‰ä½ Cmd (âŒ˜) é”®å¹¶ç§»åŠ¨é¼ æ ‡æŸ¥çœ‹ç»†èŠ‚ã€‚</li>
                <li><strong>å¿«æ·ç¿»é¡µï¼š</strong>ä½¿ç”¨é”®ç›˜ â† / â†’ é”®ã€‚</li>
                <li><strong>åˆ†è¾¨ç‡ï¼š</strong>é¼ æ ‡æ‚¬åœåœ¨åª’ä½“ä¸Šå¯æŸ¥çœ‹å°ºå¯¸ã€‚</li>
            </ul>
        </div>
    </div>
    <div id="popup" class="popup">
        <div class="popup-media-container"></div>
    </div>

    <script>
        (function() {
            // å®šä¹‰å˜é‡
            let originalImages = [];
            let images = [];
            let currentPage = 1;
            let pageSize = 2;
            let lineSize = 4;
            let totalPages = 0;
            const selectedIndices = new Set();
            let autoplayEnabled = true;
            
            // æç¤ºå†·å´æ—¶é—´æ§åˆ¶ (Requirement #2)
            let lastPageHintTime = 0;
            let lastZoomHintTime = 0;
            const HINT_COOLDOWN = 5000; // 5ç§’å†·å´
            const ZOOM_HINT_COOLDOWN = 50000; // 50ç§’å†·å´

            // DOMå…ƒç´ ç¼“å­˜
            const inputTextArea = document.getElementById("input");
            const container = document.getElementById("container");
            const currentSpan = document.getElementById("current");
            const totalSpan = document.getElementById("total");
            const prevButton = document.getElementById("prevButton");
            const nextButton = document.getElementById("nextButton");
            const exportButton = document.getElementById("exportButton");
            const outputTextArea = document.getElementById("output");
            const feedbackDiv = document.getElementById("feedback");
            const helpModal = document.getElementById("helpModal");
            const commandModal = document.getElementById("commandModal");
            const searchModal = document.getElementById("searchModal");
            const searchInput = document.getElementById("searchInput");
            const searchModeRadios = document.getElementsByName("searchMode");
            const autoplayCheckbox = document.getElementById("autoplayCheckbox");
            const autoplayLabel = document.getElementById("autoplayLabel");
            const autoplayToggle = document.getElementById("autoplayToggle");

            class LocalStorageManager {static set(key, value, expireMinutes = 60) {
                const expireTime = new Date().getTime() + (expireMinutes * 60 * 1000);
                const data = { value, expire: expireTime };
                localStorage.setItem(key, JSON.stringify(data));}
                static get(key) {
                    const data = localStorage.getItem(key);
                    if (!data) return null;
                    const { value, expire } = JSON.parse(data);
                    if (Date.now() > expire) { localStorage.removeItem(key); return null; }
                    return value;
                }
                static remove(key) { localStorage.removeItem(key); }
            }

            window.toggleAutoplay = function() {
                autoplayEnabled = !autoplayEnabled;
                autoplayCheckbox.checked = autoplayEnabled;
                if (autoplayEnabled) {
                    autoplayLabel.textContent = "ğŸ¬ è‡ªåŠ¨æ’­æ”¾";
                    autoplayToggle.classList.remove("disabled");
                } else {
                    autoplayLabel.textContent = "â¸ï¸ æ‰‹åŠ¨æ’­æ”¾";
                    autoplayToggle.classList.add("disabled");
                }
                updateAllVideosPlayState();
                LocalStorageManager.set("autoplay_v1", autoplayEnabled, 24 * 60);
                showFeedback(autoplayEnabled ? "å·²å¼€å¯è‡ªåŠ¨æ’­æ”¾" : "å·²å…³é—­è‡ªåŠ¨æ’­æ”¾");
            };

            function updateAllVideosPlayState() {
                const videos = container.querySelectorAll('video');
                videos.forEach(video => {
                    if (autoplayEnabled) {
                        video.autoplay = true;
                        video.muted = true;
                        video.play().catch(e => console.log('è§†é¢‘æ’­æ”¾å¤±è´¥:', e));
                    } else {
                        video.autoplay = false;
                        video.pause();
                    }
                });
            }

            function syntaxHighlight(json) {
                if (typeof json !== 'string') json = JSON.stringify(json, undefined, 2);
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(?=\s*:))|("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*")|(\b(true|false|null)\b)|(\b\d+\b)/g, function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) cls = 'json-key';
                        else cls = 'json-string';
                    } else if (/true|false/.test(match)) cls = 'json-boolean';
                    else if (/null/.test(match)) cls = 'json-null';
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }

            window.loadImages = function() {
                const currentHost = window.location.hostname;
                const officialHost = 'uk9921.github.io';
                if (currentHost !== officialHost && window.location.protocol !== 'data:') {
                     setTimeout(() => {
                      showFeedback("ğŸ’¡ æç¤ºï¼šç‚¹å‡»é¡¶éƒ¨å³ä¾§ç‰ˆæƒä¿¡æ¯è·å–æœ€æ–°ç‰ˆå·¥å…·.", false);
                      setTimeout(() => hideFeedback(), 5000);  // æ˜¾ç¤º5ç§’åæ¶ˆå¤±
                    }, 800);
                }
                const exportLen = exportImages();
                const text = inputTextArea.value.replace(/\t/g, "\n");
                const lines = text.split("\n").map(line => line.trim()).filter(line => line !== "");
                originalImages = lines;
                selectedIndices.size = 0;
                groupImages();
                currentPage = 1;
                totalPages = Math.ceil(images.length / pageSize);
                updatePagination();
                renderImages();
                if (!exportLen) {
                    setTimeout(() => showFeedback(`åŠ è½½äº† ${originalImages.length} ä¸ªåª’ä½“é“¾æ¥ã€‚`), 500);
                } else{
                    setTimeout(() => showFeedback(`åŠ è½½äº† ${originalImages.length} ä¸ªåª’ä½“é“¾æ¥ã€‚\n ${exportLen} ä¸ªå†…å®¹å·²å¤‡ä»½`), 500);
                }
            };

            function groupImages() {
                images = [];
                for (let i = 0; i < originalImages.length; i += lineSize) {
                    const group = originalImages.slice(i, i + lineSize);
                    images.push(group);
                }
            }

            function renderImages() {
                container.innerHTML = "";
                if (images.length === 0) {
                    container.innerHTML = "<p style='text-align:center;'>æ²¡æœ‰è¦æ˜¾ç¤ºçš„åª’ä½“ã€‚</p>";
                    return;
                }
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = Math.min(currentPage * pageSize, images.length);
                const currentRecords = images.slice(startIndex, endIndex);
                currentRecords.forEach((record, recordIndex) => {
                   record.forEach((url, index) => {
                       const globalIndex = startIndex * lineSize + recordIndex * lineSize + index;
                       const mediaItem = createMediaItem(url, globalIndex);
                       container.appendChild(mediaItem);
                   });
                });
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages;
                updateExportButton();
            }

            function createTextContent(text) {
                const textDiv = document.createElement("div");
                textDiv.className = "text-content";
                if (isJsonString(text)) {
                    try {
                        const jsonObj = JSON.parse(text);
                        textDiv.innerHTML = syntaxHighlight(jsonObj);
                    } catch (e) { textDiv.textContent = text; }
                } else { textDiv.textContent = text; }
                return textDiv;
            }

            function createImage(src) {
                const img = document.createElement("img");
                img.src = src;
                img.className = "media-content";
                img.alt = "å›¾ç‰‡å†…å®¹";
                return img;
            }

            function createVideo(src) {
                const video = document.createElement("video");
                video.src = src;
                video.autoplay = autoplayEnabled;
                video.muted = autoplayEnabled;
                video.loop = true;
                video.controls = !autoplayEnabled;
                video.className = "media-content";
                if (autoplayEnabled) video.play().catch(e => console.log('è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', e));
                return video;
            }

            function createAudio(src) {
                const audio = document.createElement("audio");
                audio.src = src;
                audio.controls = true;
                audio.autoplay = autoplayEnabled;
                audio.className = "media-content";
                audio.style.height = "50px"
                if (autoplayEnabled) audio.play().catch(e => console.log('éŸ³é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', e));
                return audio;
            }

            function createAudioButton(video) {
                const button = document.createElement("button");
                button.className = "audio-button";
                button.innerHTML = video.muted ? "ğŸ”‡" : "ğŸ”Š";
                button.addEventListener("click", (e) => {
                    e.stopPropagation();
                    video.muted = !video.muted;
                    button.innerHTML = video.muted ? "ğŸ”‡" : "ğŸ”Š";
                });
                return button;
            }

            const pageSizeInput = document.getElementById("pageSizeInput");
            pageSizeInput.value = pageSize;
            pageSizeInput.addEventListener("change", (e) => {
                const val = parseInt(e.target.value);
                if (!isNaN(val) && val > 0) {
                    pageSize = val;
                    totalPages = Math.ceil(images.length / pageSize);
                    currentPage = Math.min(currentPage, totalPages);
                    updatePagination();
                    renderImages();
                    showFeedback(`æ¯é¡µæ˜¾ç¤ºæ•°é‡è®¾ç½®ä¸º ${pageSize}ã€‚`);
                } else {
                    showFeedback("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯é¡µè¡Œæ•°ï¼ˆå¤§äº0ï¼‰ã€‚", true);
                }
            });

            const lineSizeInput = document.getElementById("lineSizeInput");
            lineSizeInput.value = lineSize;
            lineSizeInput.addEventListener("change", (e) => {
                const val = parseInt(e.target.value);
                if (!isNaN(val) && val > 0) {
                    const currentIndex = (currentPage - 1) * pageSize;
                    lineSize = val;
                    groupImages();
                    totalPages = Math.ceil(images.length / pageSize);
                    currentPage = Math.floor(currentIndex / pageSize) + 1;
                    updatePagination();
                    container.style.gridTemplateColumns = `repeat(${lineSize}, 1fr)`;
                    renderImages();
                    showFeedback(`æ¯è¡Œæ˜¾ç¤ºæ•°é‡è®¾ç½®ä¸º ${lineSize}ã€‚`);
                } else {
                    showFeedback("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯è¡Œæ•°é‡ï¼ˆå¤§äº0ï¼‰ã€‚", true);
                }
            });

            const goToPageInput = document.getElementById("goToPageInput");
            goToPageInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const page = parseInt(e.target.value);
                    if (!isNaN(page) && page >= 1 && page <= totalPages) {
                        currentPage = page;
                        updatePagination();
                        renderImages();
                        showFeedback(`è·³è½¬åˆ°ç¬¬ ${page} é¡µã€‚`);
                        e.target.value = "";
                    } else {
                        showFeedback("æ— æ•ˆçš„é¡µç ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„æ•°å­—ã€‚", true);
                    }
                }
            });

            // --- ç¿»é¡µé€»è¾‘ä¸å¼±æé†’ä¼˜åŒ– (Requirement #2) ---
            window.prevPage = function(isKeyboard = false) {
                const now = Date.now();
                if (!isKeyboard && (now - lastPageHintTime > HINT_COOLDOWN)) {
                    showFeedback("ğŸ’¡ æç¤ºï¼šæŒ‰é”®ç›˜ â† / â†’ é”®å¯å¿«é€Ÿç¿»é¡µ");
                    lastPageHintTime = now;
                }
                if (currentPage > 1) {
                    currentPage--;
                    updatePagination();
                    renderImages();
                }
            };

            window.nextPage = function(isKeyboard = false) {
                const now = Date.now();
                if (!isKeyboard && (now - lastPageHintTime > HINT_COOLDOWN)) {
                    showFeedback("ğŸ’¡ æç¤ºï¼šæŒ‰é”®ç›˜ â† / â†’ é”®å¯å¿«é€Ÿç¿»é¡µ");
                    lastPageHintTime = now;
                }
                if (currentPage < totalPages) {
                    currentPage++;
                    updatePagination();
                    renderImages();
                }
            };

            window.exportImages = function() {
                if (selectedIndices.size === 0) return null;
                const sortedIndices = Array.from(selectedIndices).sort((a, b) => a - b);
                const exported = sortedIndices.map(index => originalImages[index]).join("\n");
                outputTextArea.value = exported;
                outputTextArea.select();
                if (selectedIndices.size > 0) showFeedback("æˆåŠŸå¯¼å‡ºï¼");
                return selectedIndices.size;
            };

            window.selectAll = function() {
               const checkboxes = container.querySelectorAll(".checkbox-container input[type='checkbox']");
               checkboxes.forEach(cb => {
                   if (!cb.checked) {
                       cb.checked = true;
                       selectedIndices.add(parseInt(cb.value));
                   }
               });
               updateExportButton();
               showFeedback("æ‰€æœ‰åª’ä½“é¡¹å·²é€‰ä¸­ã€‚");
               renderImages();
            };

            window.deselectAll = function() {
               const checkboxes = container.querySelectorAll(".checkbox-container input[type='checkbox']");
               checkboxes.forEach(cb => {
                   if (cb.checked) {
                       cb.checked = false;
                       selectedIndices.delete(parseInt(cb.value));
                   }
               });
               updateExportButton();
               showFeedback("æ‰€æœ‰åª’ä½“é¡¹å·²å–æ¶ˆé€‰æ‹©ã€‚");
               renderImages();
            };

            window.performSearch = function() {
                const query = searchInput.value.trim();
                if (query === "") {
                    showFeedback("è¯·è¾“å…¥å…³é”®è¯æˆ–æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæœç´¢ã€‚", true);
                    return;
                }
                let mode = 'keyword';
                searchModeRadios.forEach(radio => { if (radio.checked) mode = radio.value; });
                if (mode === 'regex') {
                    try { new RegExp(query); } catch (e) {
                        showFeedback("æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¯·æ£€æŸ¥åé‡è¯•ã€‚", true);
                        return;
                    }
                }
                let filtered = [];
                if (mode === 'keyword') {
                    filtered = originalImages.reduce((acc, url, index) => {
                        const groupIndex = Math.floor(index / lineSize);
                        if (!acc[groupIndex]) acc[groupIndex] = [];
                        acc[groupIndex].push(url);
                        return acc;
                    }, []).filter(record => record.some(url => url.toLowerCase().includes(query.toLowerCase())));
                } else if (mode === 'regex') {
                    const regex = new RegExp(query, 'i');
                    filtered = originalImages.reduce((acc, url, index) => {
                        const groupIndex = Math.floor(index / lineSize);
                        if (!acc[groupIndex]) acc[groupIndex] = [];
                        acc[groupIndex].push(url);
                        return acc;
                    }, []).filter(record => record.some(url => regex.test(url)));
                }
                images = filtered;
                currentPage = 1;
                totalPages = Math.ceil(images.length / pageSize);
                updatePagination();
                renderImages();
                closeSearch();
                showFeedback(`æœç´¢åå‰©ä½™ ${images.length} ä¸ªè®°å½•ã€‚`);
            };

            window.clearSearch = function() {
                if (confirm("ç¡®å®šè¦æ¸…ç©ºæœç´¢æ¡ä»¶å¹¶æ¢å¤æ‰€æœ‰åª’ä½“é¡¹å—ï¼Ÿ")) {
                    groupImages();
                    currentPage = 1;
                    totalPages = Math.ceil(images.length / pageSize);
                    updatePagination();
                    container.style.gridTemplateColumns = `repeat(${lineSize}, 1fr)`;
                    renderImages();
                    closeSearch();
                    showFeedback("å·²æ¸…ç©ºæœç´¢æ¡ä»¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰åª’ä½“é¡¹ã€‚");
                }
            };

            window.openSearch = function() { searchModal.style.display = "block"; searchInput.focus(); };
            window.closeSearch = function() { searchModal.style.display = "none"; searchInput.value = ""; };
            window.openCommandHelp = function() { commandModal.style.display = "block"; };
            window.closeCommandHelp = function() { commandModal.style.display = "none"; };
            window.openHelp = function() { helpModal.style.display = "block"; };
            window.closeHelp = function() { helpModal.style.display = "none"; };

            function applyAutomaticTheme() {
                const savedTheme = LocalStorageManager.get("theme_v2");
                if (savedTheme) {
                    document.body.classList.remove("light-theme", "dark-theme");
                    document.body.classList.add(`${savedTheme}-theme`);
                } else {
                    const hour = new Date().getHours();
                    if (hour >= 19 || hour < 6) {
                        document.body.classList.add("dark-theme");
                        showFeedback("ä¸ºæ‚¨å¼€å¯æŠ¤çœ¼æ¨¡å¼â˜•ï¸")
                    } else {
                        document.body.classList.add("light-theme");
                    }
                }
            }

            function loadAutoplaySettings() {
                const savedAutoplay = LocalStorageManager.get("autoplay_v1");
                if (savedAutoplay !== null) autoplayEnabled = savedAutoplay;
                else autoplayEnabled = true;
                autoplayCheckbox.checked = autoplayEnabled;
                if (autoplayEnabled) {
                    autoplayLabel.textContent = "ğŸ¬ è‡ªåŠ¨æ’­æ”¾";
                    autoplayToggle.classList.remove("disabled");
                } else {
                    autoplayLabel.textContent = "â¸ï¸ æ‰‹åŠ¨æ’­æ”¾";
                    autoplayToggle.classList.add("disabled");
                }
            }

            window.toggleTheme = function() {
                const body = document.body;
                body.classList.toggle("dark-theme");
                body.classList.toggle("light-theme");
                if (body.classList.contains("dark-theme")) {
                    LocalStorageManager.set("theme_v2", "dark", 0.1);
                } else {
                    LocalStorageManager.set("theme_v2", "light", 0.1);
                }
                showFeedback("å·²è®°ä½æ‚¨çš„ä¸»é¢˜è®¾ç½®(æœ‰æ•ˆæœŸ24h)");
            };

            function updatePagination() {
                currentSpan.textContent = currentPage;
                totalSpan.textContent = totalPages;
            }

            function updateExportButton() {
                if (selectedIndices.size > 0) {
                    exportButton.innerHTML = `å¯¼å‡ºé€‰ä¸­é“¾æ¥ (${selectedIndices.size})`;
                    exportButton.disabled = false;
                } else {
                    exportButton.innerHTML = 'å¯¼å‡ºé€‰ä¸­é“¾æ¥';
                    exportButton.disabled = true;
                }
            }

            function isJsonString(str) {
                try { const parsed = JSON.parse(str); return !(typeof parsed === 'number' && !isNaN(parsed)); } catch (e) { return false; }
            }
            function isVideo(url) { return /\.(mp4|webm|ogg)(\?.*)?$/i.test(url); }
            function isAudio(url) { return /\.(mp3|wav|aac|flac)(\?.*)?$/i.test(url); }
            function isImage(url) { return /\.(jpg|jpeg|png|gif|bmp|webp)(\?.*)?$/i.test(url); }

            function showFeedback(message, isError = false) {
                feedbackDiv.textContent = message;
                feedbackDiv.classList.remove("error");
                if (isError) feedbackDiv.classList.add("error");
                feedbackDiv.classList.add("show");
                setTimeout(() => { feedbackDiv.classList.remove("show"); }, 3000);
            }

            document.addEventListener("DOMContentLoaded", () => {
                applyAutomaticTheme();
                loadAutoplaySettings();
                container.style.gridTemplateColumns = `repeat(${lineSize}, 1fr)`;
                totalPages = Math.ceil(images.length / pageSize);
                updatePagination();
                renderImages();
            });

            document.addEventListener('keydown', function(event) {
                if (event.target.tagName.toLowerCase() === 'input' || event.target.tagName.toLowerCase() === 'textarea') return;
                if (event.key === 'ArrowLeft') prevPage(true);
                else if (event.key === 'ArrowRight') nextPage(true);
            });
            
            // --- Requirement #3: ç›‘å¬æµè§ˆå™¨ç¼©æ”¾/åŒæŒ‡æåˆ ---
            // ç›‘å¬åŒæŒ‡æåˆ (è§¦æ§æ¿é€šå¸¸æ¨¡æ‹Ÿ Ctrl + Wheel)
            document.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    showFeedback("ğŸ’¡ æç¤ºï¼šæ— éœ€ç¼©æ”¾æµè§ˆå™¨ï¼ŒæŒ‰ä½ âŒ˜ (Command) é”®ç§»åŠ¨é¼ æ ‡å³å¯ä½¿ç”¨å±€éƒ¨æ”¾å¤§é•œ", false);
                }
            }, { passive: true });

            // ç›‘å¬ Cmd +/- (é”®ç›˜ç¼©æ”¾)
            document.addEventListener('keydown', function(e) {
                if ((e.metaKey || e.ctrlKey) && (e.key === '=' || e.key === '+' || e.key === '-')) {
                     showFeedback("ğŸ’¡ æç¤ºï¼šæ— éœ€ç¼©æ”¾æµè§ˆå™¨ï¼ŒæŒ‰ä½ âŒ˜ (Command) é”®ç§»åŠ¨é¼ æ ‡å³å¯ä½¿ç”¨å±€éƒ¨æ”¾å¤§é•œ", false);
                }
            });

            const popup = document.getElementById("popup");
            const popupMediaContainer = document.querySelector("#popup .popup-media-container");
            
            function hidePopup() {
                popup.classList.remove("show");
                popup.classList.remove("arrow-left", "arrow-right");
                popupMediaContainer.innerHTML = "";
            }

            function toggleSelection(mediaItem, index, isSelected) {
               if (isSelected) {
                   selectedIndices.add(index);
                   mediaItem.classList.add("selected");
               } else {
                   selectedIndices.delete(index);
                   mediaItem.classList.remove("selected");
               }
               updateExportButton();
            }

            function createMediaItem(url, index) {
                const div = document.createElement("div");
                div.className = "media-item";
                let mediaElement;
                let resolutionBadge = document.createElement("div");
                resolutionBadge.className = "resolution-badge";
                resolutionBadge.textContent = ""; // é»˜è®¤ç©º
                
                if (isJsonString(url)) {
                    try {
                        const jsonObj = JSON.stringify(JSON.parse(url), null, 2) + '\n\n';
                        mediaElement = createTextContent(jsonObj);
                    } catch (e) { mediaElement = createTextContent(url); }
                } else if (isVideo(url)) {
                    const videoContainer = document.createElement("div");
                    videoContainer.className = "video-container";
                    videoContainer.style.position = "relative";
                    const video = createVideo(url);
                    
                    // è·å–åˆ†è¾¨ç‡ (Requirement #1)
                    video.addEventListener('loadedmetadata', () => {
                        resolutionBadge.textContent = `${video.videoWidth} x ${video.videoHeight}`;
                    });

                    videoContainer.appendChild(video);
                    videoContainer.appendChild(createAudioButton(video));
                    mediaElement = videoContainer;
                    addZoomFunctionality(div, mediaElement);
                } else if (isImage(url)) {
                    mediaElement = createImage(url);
                    
                    // è·å–åˆ†è¾¨ç‡ (Requirement #1)
                    mediaElement.onload = () => {
                         resolutionBadge.textContent = `${mediaElement.naturalWidth} x ${mediaElement.naturalHeight}`;
                    };

                    addZoomFunctionality(div, mediaElement);
                } else if (isAudio(url)) {
                    mediaElement = createAudio(url);
                } else {
                    mediaElement = createTextContent(url);
                }

                const checkboxContainer = document.createElement("div");
                checkboxContainer.className = "checkbox-container";
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = index;
                if (selectedIndices.has(index)) {
                    checkbox.checked = true;
                    div.classList.add("selected");
                }
                checkbox.addEventListener("click", (e) => {
                    e.stopPropagation();
                    toggleSelection(div, index, checkbox.checked);
                });
                checkboxContainer.appendChild(checkbox);
                div.appendChild(mediaElement);
                div.appendChild(checkboxContainer);
                
                // æ·»åŠ åˆ†è¾¨ç‡æ ‡ç­¾åˆ°å®¹å™¨
                if (isVideo(url) || isImage(url)) {
                    div.appendChild(resolutionBadge);
                }

                mediaElement.addEventListener("click", () => {
                    const isChecked = !checkbox.checked;
                    checkbox.checked = !checkbox.checked;
                    toggleSelection(div, index, isChecked);
                });
                return div;
            }

            function addZoomFunctionality(container, mediaElement) {
                // æ”¾å¤§æç¤ºå†·å´é€»è¾‘ (Requirement #2)
                mediaElement.addEventListener('mouseenter', () => {
                     const now = Date.now();
                     if(now - lastZoomHintTime > HINT_COOLDOWN) {
                         showFeedback("ğŸ’¡ æç¤ºï¼šæŒ‰ä½ âŒ˜ (Command) é”®æ»‘åŠ¨é¼ æ ‡å¯æ”¾å¤§ç»†èŠ‚");
                         lastZoomHintTime = now;
                     }
                });

                const magnifierBox = document.createElement('div');
                magnifierBox.className = 'magnifier-box';
                container.appendChild(magnifierBox);
                const zoomBox = document.createElement('div');
                zoomBox.className = 'zoom-box';
                document.body.appendChild(zoomBox);
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                zoomBox.appendChild(canvas);
                let naturalWidth, naturalHeight;
                
                // è·å–åª’ä½“å…ƒç´ 
                let actualMedia = mediaElement;
                if (mediaElement.tagName.toLowerCase() === 'div' && mediaElement.querySelector('video')) {
                    actualMedia = mediaElement.querySelector('video');
                }

                if (actualMedia.tagName.toLowerCase() === 'img') {
                    naturalWidth = actualMedia.naturalWidth;
                    naturalHeight = actualMedia.naturalHeight;
                    if (!naturalWidth) {
                        actualMedia.addEventListener('loadedmetadata', () => {
                            naturalWidth = actualMedia.naturalWidth;
                            naturalHeight = actualMedia.naturalHeight;
                        });
                    }
                } else if (actualMedia.tagName.toLowerCase() === 'video') {
                    naturalWidth = actualMedia.videoWidth;
                    naturalHeight = actualMedia.videoHeight;
                    if (!naturalWidth) {
                        actualMedia.addEventListener('loadedmetadata', () => {
                            naturalWidth = actualMedia.videoWidth;
                            naturalHeight = actualMedia.videoHeight;
                        });
                    }
                }

                function throttle(func, limit) {
                    let lastFunc, lastRan;
                    return function(...args) {
                        const context = this;
                        if (!lastRan) {
                            func.apply(context, args);
                            lastRan = Date.now();
                        } else {
                            clearTimeout(lastFunc);
                            lastFunc = setTimeout(function() {
                                if ((Date.now() - lastRan) >= limit) {
                                    func.apply(context, args);
                                    lastRan = Date.now();
                                }
                            }, limit - (Date.now() - lastRan));
                        }
                    }
                }
                const sourceWidth = 60;
                const sourceHeight = 60;
                let isZoomActive = false;
                let animationFrameId;
                let lastMouseEvent = null;
                
                const updateZoom = () => {
                    if (!isZoomActive) return;
                    const e = lastMouseEvent;
                    if (!e) {
                        animationFrameId = requestAnimationFrame(updateZoom);
                        return;
                    }
                    const rect = actualMedia.getBoundingClientRect();
                    
                    // é‡æ–°æ£€æŸ¥å°ºå¯¸
                    if (!naturalWidth || !naturalHeight) {
                        if (actualMedia.tagName === 'IMG') {
                            naturalWidth = actualMedia.naturalWidth;
                            naturalHeight = actualMedia.naturalHeight;
                        } else if (actualMedia.tagName === 'VIDEO') {
                            naturalWidth = actualMedia.videoWidth;
                            naturalHeight = actualMedia.videoHeight;
                        }
                        if(!naturalWidth) {
                             animationFrameId = requestAnimationFrame(updateZoom);
                             return;
                        }
                    }

                    const scaleX = naturalWidth / rect.width;
                    const scaleY = naturalHeight / rect.height;
                    
                    // è®¡ç®—æ”¾å¤§é•œä¸­å¿ƒåœ¨åŸå›¾çš„åæ ‡
                    // containerå±…ä¸­ç­–ç•¥å¯¼è‡´å›¾åƒå¯èƒ½æœ‰åç§»ï¼Œéœ€è¦ç®€å•è®¡ç®—
                    // ç®€åŒ–ç‰ˆæœ¬ï¼šå‡è®¾object-fit: containå±…ä¸­
                    
                    // æ›´ç²¾ç¡®çš„è®¡ç®—
                    // å®é™…æ˜¾ç¤ºçš„å›¾åƒå®½é«˜
                    const displayRatio = rect.width / rect.height;
                    const naturalRatio = naturalWidth / naturalHeight;
                    let renderW = rect.width;
                    let renderH = rect.height;
                    let offsetX = 0;
                    let offsetY = 0;

                    if (displayRatio > naturalRatio) {
                        // å®¹å™¨æ›´å®½ï¼Œé«˜åº¦å¡«æ»¡ï¼Œå®½åº¦ç•™ç™½
                        renderW = rect.height * naturalRatio;
                        offsetX = (rect.width - renderW) / 2;
                    } else {
                        // å®¹å™¨æ›´é«˜ï¼Œå®½åº¦å¡«æ»¡ï¼Œé«˜åº¦ç•™ç™½
                        renderH = rect.width / naturalRatio;
                        offsetY = (rect.height - renderH) / 2;
                    }

                    // é¼ æ ‡ç›¸å¯¹äºå›¾ç‰‡çš„å®é™…åæ ‡
                    let mouseXInRender = e.clientX - rect.left - offsetX;
                    let mouseYInRender = e.clientY - rect.top - offsetY;

                    // æ˜ å°„åˆ°åŸå›¾åæ ‡
                    let targetX = (mouseXInRender / renderW) * naturalWidth;
                    let targetY = (mouseYInRender / renderH) * naturalHeight;

                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    try {
                        // åªæœ‰å½“é¼ æ ‡åœ¨æ¸²æŸ“åŒºåŸŸå†…æ‰ç»˜åˆ¶
                        if (mouseXInRender >=0 && mouseXInRender <= renderW && mouseYInRender >=0 && mouseYInRender <= renderH) {
                             ctx.drawImage(
                                actualMedia,
                                targetX - sourceWidth, targetY - sourceHeight, sourceWidth * 2, sourceHeight * 2,
                                0, 0, canvas.width, canvas.height
                            );
                        }
                    } catch (error) { console.error(error); }

                    const displayX = e.clientX - rect.left - (sourceWidth / 2);
                    const displayY = e.clientY - rect.top - (sourceHeight / 2);
                    magnifierBox.style.left = `${displayX}px`;
                    magnifierBox.style.top = `${displayY}px`;
                    magnifierBox.style.display = 'block';
                    
                    let zoomBoxLeft = e.clientX + 32;
                    let zoomBoxTop = e.clientY - 200;
                    if (zoomBoxLeft + 400 > window.innerWidth) zoomBoxLeft = e.clientX - 420;
                    if (zoomBoxTop < 0) zoomBoxTop = 0;
                    else if (zoomBoxTop + 400 > window.innerHeight) zoomBoxTop = window.innerHeight - 400;
                    
                    zoomBox.style.left = `${zoomBoxLeft}px`;
                    zoomBox.style.top = `${zoomBoxTop}px`;
                    zoomBox.style.display = 'block';
                    animationFrameId = requestAnimationFrame(updateZoom);
                }

                const handleMouseMove = throttle((e) => {
                    lastMouseEvent = e;
                    if (e.metaKey) {
                        if (!isZoomActive) {
                            isZoomActive = true;
                            updateZoom();
                        }
                    } else {
                        if (isZoomActive) {
                            isZoomActive = false;
                            magnifierBox.style.display = 'none';
                            zoomBox.style.display = 'none';
                            cancelAnimationFrame(animationFrameId);
                        }
                    }
                }, 16);
                
                actualMedia.addEventListener('mousemove', handleMouseMove);
                
                const hideZoom = () => {
                    if (isZoomActive) {
                        isZoomActive = false;
                        magnifierBox.style.display = 'none';
                        zoomBox.style.display = 'none';
                        cancelAnimationFrame(animationFrameId);
                    }
                }
                actualMedia.addEventListener('mouseleave', hideZoom);
                document.addEventListener('keyup', (e) => { if (e.key === 'Meta') hideZoom(); });
            }

            const commandIcon = document.querySelector('.command-icon');
            document.addEventListener('keydown', function(e) { if (e.metaKey) commandIcon.classList.add('active'); });
            document.addEventListener('keyup', function(e) { if (e.key === 'Meta') commandIcon.classList.remove('active'); });
            document.addEventListener('click', function(event) { if (!popup.contains(event.target)) hidePopup(); });

            window.savePage = function() {
                const data = originalImages.map(url => ({
                    url: url,
                    selected: selectedIndices.has(originalImages.indexOf(url))
                }));
                let currentHtml = document.documentElement.outerHTML;
                currentHtml = currentHtml
                    .replace(/let originalImages = \[[\s\S]*?\];/, `let originalImages = ${JSON.stringify(originalImages, null,4)};`)
                    .replace(/let images = \[[\s\S]*?\];/, `let images = ${JSON.stringify(images, null, 4)};`)
                    .replace(/let currentPage = \d+;/, `let currentPage = ${currentPage};`)
                    .replace(/let pageSize = \d+;/, `let pageSize = ${pageSize};`)
                    .replace(/let lineSize = \d+;/, `let lineSize = ${lineSize};`)
                    .replace(/let autoplayEnabled = (true|false);/, `let autoplayEnabled = ${autoplayEnabled};`)
                    .replace(/const selectedIndices = new Set\(\);/, `const selectedIndices = new Set(${JSON.stringify(Array.from(selectedIndices))});`);
                
                const escapedUrls = originalImages.map(url => {
                    return url.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                }).join("\n");

                currentHtml = currentHtml.replace(
                    /<textarea\s+id=["']input["'][^>]*>[\s\S]*?<\/textarea>/,
                    `<textarea id="input" placeholder="æ¯è¡Œä¸€ä¸ªé“¾æ¥...">${escapedUrls}</textarea>`
                );

                if (autoplayEnabled) currentHtml = currentHtml.replace(/<input type="checkbox" id="autoplayCheckbox"[^>]*>/, '<input type="checkbox" id="autoplayCheckbox" checked>');
                else currentHtml = currentHtml.replace(/<input type="checkbox" id="autoplayCheckbox"[^>]*>/, '<input type="checkbox" id="autoplayCheckbox">');

                const blob = new Blob([currentHtml], { type: "text/html" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "saved_demo_page.html";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showFeedback("é¡µé¢å·²ä¿å­˜ä¸º saved_demo_page.html");
            };
        })();
    </script>
</body>
</html>
